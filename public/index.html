<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clash of Pop Culture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .neon-text {
            text-shadow: 0 0 10px currentColor;
        }
    </style>
</head>

<body
    class="bg-slate-900 text-white h-screen flex flex-col items-center justify-center overflow-hidden selection:bg-fuchsia-500 selection:text-white">

    <div
        class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 pointer-events-none">
    </div>

    <main class="relative z-10 w-full max-w-4xl p-8 text-center">
        <h1
            class="text-6xl font-black mb-12 tracking-tighter bg-gradient-to-r from-cyan-400 to-fuchsia-400 bg-clip-text text-transparent animate-pulse">
            CLASH OF POP CULTURE
        </h1>

        <div id="battle-arena" class="grid grid-cols-1 md:grid-cols-3 gap-8 items-center mb-12">
            <!-- Option A -->
            <button id="btn-a" onclick="vote('A')"
                class="group relative p-8 rounded-2xl border-2 border-slate-700 hover:border-cyan-400 transition-all duration-300 hover:scale-105 active:scale-95 overflow-hidden">
                <!-- Progress Bar Background -->
                <div id="progress-a"
                    class="absolute inset-0 bg-cyan-900/50 origin-left transition-transform duration-1000 scale-x-0 z-0">
                </div>

                <div class="relative z-10">
                    <div
                        class="absolute inset-0 bg-cyan-500/10 opacity-0 group-hover:opacity-100 transition-opacity rounded-2xl">
                    </div>
                    <h2 id="option-a"
                        class="text-3xl font-bold text-slate-300 group-hover:text-cyan-400 transition-colors">Loading...
                    </h2>
                    <div id="percent-a" class="text-4xl font-black text-cyan-400 mt-2 opacity-0 transition-opacity">0%
                    </div>
                    <div class="mt-4 text-sm font-mono text-slate-500 group-hover:text-cyan-300">PRESS A</div>
                </div>
            </button>

            <!-- VS -->
            <div class="text-4xl font-black text-slate-600 italic">VS</div>

            <!-- Option B -->
            <button id="btn-b" onclick="vote('B')"
                class="group relative p-8 rounded-2xl border-2 border-slate-700 hover:border-fuchsia-400 transition-all duration-300 hover:scale-105 active:scale-95 overflow-hidden">
                <!-- Progress Bar Background -->
                <div id="progress-b"
                    class="absolute inset-0 bg-fuchsia-900/50 origin-left transition-transform duration-1000 scale-x-0 z-0">
                </div>

                <div class="relative z-10">
                    <div
                        class="absolute inset-0 bg-fuchsia-500/10 opacity-0 group-hover:opacity-100 transition-opacity rounded-2xl">
                    </div>
                    <h2 id="option-b"
                        class="text-3xl font-bold text-slate-300 group-hover:text-fuchsia-400 transition-colors">
                        Loading...</h2>
                    <div id="percent-b" class="text-4xl font-black text-fuchsia-400 mt-2 opacity-0 transition-opacity">
                        0%</div>
                    <div class="mt-4 text-sm font-mono text-slate-500 group-hover:text-fuchsia-300">PRESS B</div>
                </div>
            </button>
        </div>

        <!-- Status / Timer -->
        <div class="flex flex-col items-center gap-4">
            <div id="phase-indicator" class="text-xl font-bold tracking-widest uppercase text-slate-400">WAITING...
            </div>
            <div class="w-full max-w-md h-2 bg-slate-800 rounded-full overflow-hidden">
                <div id="timer-bar"
                    class="h-full bg-gradient-to-r from-cyan-500 to-fuchsia-500 w-full transition-all duration-1000 ease-linear">
                </div>
            </div>
            <div id="time-left" class="font-mono text-slate-500">00s</div>
        </div>
    </main>

    <script>
        let currentUserVote = null;
        let currentBattleId = null;

        async function syncState() {
            try {
                const res = await fetch('/api/state');
                const data = await res.json();
                render(data);
            } catch (e) {
                console.error("Connection lost", e);
            }
        }

        async function vote(choice) {
            if (currentUserVote) return; // Prevent multiple votes

            try {
                // Optimistic update
                currentUserVote = choice;

                // Immediate UI feedback: Disable buttons
                updateButtonState(true);
                applySelectionStyle(choice);

                await fetch('/api/vote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ choice })
                });

            } catch (e) {
                console.error("Vote failed", e);
                // In a real app, we might revert currentUserVote here if the network fails
            }
        }

        function applySelectionStyle(choice) {
            // Reset borders
            document.getElementById('btn-a').classList.remove('border-yellow-400', 'shadow-[0_0_30px_rgba(250,204,21,0.5)]');
            document.getElementById('btn-b').classList.remove('border-yellow-400', 'shadow-[0_0_30px_rgba(250,204,21,0.5)]');

            if (choice === 'A') {
                document.getElementById('btn-a').classList.add('border-yellow-400', 'shadow-[0_0_30px_rgba(250,204,21,0.5)]');
            } else if (choice === 'B') {
                document.getElementById('btn-b').classList.add('border-yellow-400', 'shadow-[0_0_30px_rgba(250,204,21,0.5)]');
            }
        }

        function updateButtonState(isDisabled) {
            document.getElementById('btn-a').disabled = isDisabled;
            document.getElementById('btn-b').disabled = isDisabled;

            if (isDisabled) {
                document.getElementById('btn-a').classList.add('cursor-not-allowed');
                document.getElementById('btn-b').classList.add('cursor-not-allowed');
            } else {
                document.getElementById('btn-a').classList.remove('cursor-not-allowed');
                document.getElementById('btn-b').classList.remove('cursor-not-allowed');
            }
        }

        function render(state) {
            // Detect new battle to reset vote
            if (currentBattleId !== state.id) {
                currentBattleId = state.id;
                currentUserVote = null;
            }

            // Update Text
            document.getElementById('option-a').innerText = state.battle.A;
            document.getElementById('option-b').innerText = state.battle.B;

            // Update Phase
            const phaseEl = document.getElementById('phase-indicator');
            const timerBar = document.getElementById('timer-bar');
            const timeLeftEl = document.getElementById('time-left');

            phaseEl.innerText = state.phase === 'VOTE' ? 'VOTE NOW!' : 'RESULTS';
            phaseEl.className = `text-xl font-bold tracking-widest uppercase ${state.phase === 'VOTE' ? 'text-green-400 animate-pulse' : 'text-yellow-400'}`;

            // Show vote time remaining if in vote phase
            const displayTime = state.phase === 'VOTE' ? (state.timeLeft - 5) : 0;
            timeLeftEl.innerText = displayTime + 's';

            // Simple timer visualization (10s vote cycle)
            let percentage = 0;
            if (state.phase === 'VOTE') {
                percentage = ((state.timeLeft - 5) / 10) * 100;
            }
            timerBar.style.width = `${percentage}%`;

            // Determine if buttons should be disabled
            // Disabled if: Result phase OR Already voted
            const isResult = state.phase !== 'VOTE';
            const isDisabled = isResult || currentUserVote !== null;

            updateButtonState(isDisabled);

            // Apply selection style
            applySelectionStyle(currentUserVote);

            // Handle Results Visualization
            const progressA = document.getElementById('progress-a');
            const progressB = document.getElementById('progress-b');
            const percentA = document.getElementById('percent-a');
            const percentB = document.getElementById('percent-b');

            if (isResult) {
                // Show percentages
                progressA.style.transform = `scaleX(${state.results.A / 100})`;
                progressB.style.transform = `scaleX(${state.results.B / 100})`;

                percentA.innerText = state.results.A + '%';
                percentB.innerText = state.results.B + '%';

                percentA.classList.remove('opacity-0');
                percentB.classList.remove('opacity-0');
            } else {
                // Reset
                progressA.style.transform = 'scaleX(0)';
                progressB.style.transform = 'scaleX(0)';
                percentA.classList.add('opacity-0');
                percentB.classList.add('opacity-0');
            }
        }

        // Poll every second
        setInterval(syncState, 1000);
        syncState(); // Initial call
    </script>
</body>

</html>